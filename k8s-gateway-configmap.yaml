apiVersion: v1
kind: ConfigMap
metadata:
  name: rag-gateway-config
  namespace: default
data:
  gateway_config.json: |
    {
      "ts": 1762114713,
      "version": "1.0.0",
      "note": "auto-generated from notebook (cooldowns + sync + grafana + schema)",
      "rbac": {
        "ts": 1762114702,
        "schema": "rbac/1",
        "roles": {
          "admin": [
            "chaos.set",
            "chaos.ns.set",
            "rl.update",
            "rl.promote",
            "rl.rollback",
            "drift.remediate",
            "ops.write"
          ],
          "ml": [
            "rl.update",
            "rl.promote",
            "rl.rollback"
          ],
          "sre": [
            "chaos.set",
            "chaos.ns.set",
            "drift.remediate",
            "ops.write"
          ],
          "read-only": [
            "metrics.read",
            "runs.read",
            "ns.smoke"
          ]
        },
        "tokens": {
          "real-prod-token-123": "admin",
          "ml-team-token-456": "ml"
        },
        "actions": {
          "chaos.set": "Set global chaos flags",
          "chaos.ns.set": "Set per-namespace chaos flags",
          "rl.update": "Update router/RL weights",
          "rl.promote": "Promote RL weights live",
          "rl.rollback": "Rollback RL weights",
          "drift.remediate": "Apply desired state to live gateway",
          "ops.write": "Regenerate ops / oncall docs",
          "metrics.read": "Read /metrics, prom, telemetry",
          "runs.read": "Read gateway_runs_agg + smoke",
          "ns.smoke": "Hit /answer with x-namespace for smoke tests"
        }
      },
      "tenants": {
        "ts": 1762114702,
        "schema": "tenants/1",
        "tenants": {
          "default": {
            "chaos": {
              "disable_ce": false,
              "force_bm25": false,
              "verifier_v2": false
            },
            "rl_weights": {
              "factual": 1.0,
              "sql": 1.0
            }
          },
          "tenant-acme": {
            "chaos": {
              "disable_ce": true,
              "force_bm25": false
            },
            "rl_weights": {
              "factual": 0.7,
              "sql": 1.2
            }
          },
          "tenant-beta": {
            "chaos": {
              "disable_ce": false,
              "force_bm25": true
            },
            "rl_weights": {
              "factual": 1.0,
              "sql": 1.0
            }
          }
        }
      },
      "desired_state": {
        "ts": 1761843687,
        "chaos": {
          "disable_ce": false,
          "force_bm25": false,
          "verifier_v2": false
        },
        "rl_weights": {
          "factual": 1.0,
          "sql": 1.0
        },
        "namespaces": [
          "default",
          "tenant-acme"
        ],
        "_meta": {
          "source": "notebook/gateway",
          "schema_version": "1.1.0",
          "written_at": 1761846562
        },
        "ops_profile": "daily"
      },
      "schema_report": {},
      "grafana_dashboard": {
        "annotations": {
          "list": []
        },
        "editable": true,
        "gnetId": null,
        "graphTooltip": 0,
        "id": null,
        "links": [],
        "panels": [
          {
            "type": "timeseries",
            "title": "Gateway latency p95 (ms)",
            "datasource": {
              "type": "prometheus",
              "uid": "Prometheus"
            },
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(gateway_answer_latency_ms_bucket[5m])) by (le))",
                "legendFormat": "p95",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 9,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "type": "timeseries",
            "title": "Fanout errors by step",
            "datasource": {
              "type": "prometheus",
              "uid": "Prometheus"
            },
            "targets": [
              {
                "expr": "sum(rate(gateway_fanout_errors_total[5m])) by (step)",
                "legendFormat": "{{step}}",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 9,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "type": "timeseries",
            "title": "Strategy mix",
            "datasource": {
              "type": "prometheus",
              "uid": "Prometheus"
            },
            "targets": [
              {
                "expr": "sum(rate(gateway_strategy_selected_total[5m])) by (strategy)",
                "legendFormat": "{{strategy}}",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 9
            }
          }
        ],
        "refresh": "30s",
        "schemaVersion": 36,
        "style": "dark",
        "tags": [
          "rag",
          "gateway"
        ],
        "templating": {
          "list": []
        },
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "timepicker": {},
        "timezone": "",
        "title": "RAG Gateway",
        "uid": "rag-gateway",
        "version": 1
      }
    }
  gateway_rbac.json: |
    {
      "ts": 1762114702,
      "schema": "rbac/1",
      "roles": {
        "admin": [
          "chaos.set",
          "chaos.ns.set",
          "rl.update",
          "rl.promote",
          "rl.rollback",
          "drift.remediate",
          "ops.write"
        ],
        "ml": [
          "rl.update",
          "rl.promote",
          "rl.rollback"
        ],
        "sre": [
          "chaos.set",
          "chaos.ns.set",
          "drift.remediate",
          "ops.write"
        ],
        "read-only": [
          "metrics.read",
          "runs.read",
          "ns.smoke"
        ]
      },
      "tokens": {
        "real-prod-token-123": "admin",
        "ml-team-token-456": "ml"
      },
      "actions": {
        "chaos.set": "Set global chaos flags",
        "chaos.ns.set": "Set per-namespace chaos flags",
        "rl.update": "Update router/RL weights",
        "rl.promote": "Promote RL weights live",
        "rl.rollback": "Rollback RL weights",
        "drift.remediate": "Apply desired state to live gateway",
        "ops.write": "Regenerate ops / oncall docs",
        "metrics.read": "Read /metrics, prom, telemetry",
        "runs.read": "Read gateway_runs_agg + smoke",
        "ns.smoke": "Hit /answer with x-namespace for smoke tests"
      }
    }
  gateway_tenants.json: |
    {
      "ts": 1762114702,
      "schema": "tenants/1",
      "tenants": {
        "default": {
          "chaos": {
            "disable_ce": false,
            "force_bm25": false,
            "verifier_v2": false
          },
          "rl_weights": {
            "factual": 1.0,
            "sql": 1.0
          }
        },
        "tenant-acme": {
          "chaos": {
            "disable_ce": true,
            "force_bm25": false
          },
          "rl_weights": {
            "factual": 0.7,
            "sql": 1.2
          }
        },
        "tenant-beta": {
          "chaos": {
            "disable_ce": false,
            "force_bm25": true
          },
          "rl_weights": {
            "factual": 1.0,
            "sql": 1.0
          }
        }
      }
    }
  gateway_desired_state.json: |
    {
      "ts": 1761843687,
      "chaos": {
        "disable_ce": false,
        "force_bm25": false,
        "verifier_v2": false
      },
      "rl_weights": {
        "factual": 1.0,
        "sql": 1.0
      },
      "namespaces": [
        "default",
        "tenant-acme"
      ],
      "_meta": {
        "source": "notebook/gateway",
        "schema_version": "1.1.0",
        "written_at": 1761846562
      },
      "ops_profile": "daily"
    }
  gateway_grafana_dashboard.json: |
    {
      "annotations": {
        "list": []
      },
      "editable": true,
      "gnetId": null,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "type": "timeseries",
          "title": "Gateway latency p95 (ms)",
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(gateway_answer_latency_ms_bucket[5m])) by (le))",
              "legendFormat": "p95",
              "refId": "A"
            }
          ],
          "gridPos": {
            "h": 9,
            "w": 12,
            "x": 0,
            "y": 0
          }
        },
        {
          "type": "timeseries",
          "title": "Fanout errors by step",
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "expr": "sum(rate(gateway_fanout_errors_total[5m])) by (step)",
              "legendFormat": "{{step}}",
              "refId": "A"
            }
          ],
          "gridPos": {
            "h": 9,
            "w": 12,
            "x": 12,
            "y": 0
          }
        },
        {
          "type": "timeseries",
          "title": "Strategy mix",
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "expr": "sum(rate(gateway_strategy_selected_total[5m])) by (strategy)",
              "legendFormat": "{{strategy}}",
              "refId": "A"
            }
          ],
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 9
          }
        }
      ],
      "refresh": "30s",
      "schemaVersion": 36,
      "style": "dark",
      "tags": [
        "rag",
        "gateway"
      ],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "",
      "title": "RAG Gateway",
      "uid": "rag-gateway",
      "version": 1
    }
  gateway_ops_docs.md: |
    # Gateway Ops (Notebook Edition)
    
    ## 1. Alert checks (cooldown)
    ```python
    alert_on_agg_with_cooldown(1800.0, 900)
    ```
    
    ## 2. Sync staging/EU from prod
    ```python
    sync_gateways_from_source('http://127.0.0.1:9910')
    ```
    
    ## 3. Hot-reload
    ```python
    notebook_hot_reload_loop(interval_s=5.0, max_loops=100)
    ```
    
    ## 4. Grafana
    ```python
    write_grafana_dashboard()
    ```